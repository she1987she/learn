<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å››å­æ£‹ï½œMario ä¸»é¡ŒéŠæˆ²</title>
  <link rel="stylesheet" href="index.css">
</head>
<body class="mario-bg">
  <header class="mario-header">
    <button class="mario-btn mario-back" onclick="location.href='index.html'">è¿”å›éŠæˆ²é¦–é </button>
    <h1 class="mario-title">å››å­æ£‹</h1>
  </header>
  <main class="mario-main">
    <section class="mario-game-area">
      <p class="mario-desc">Mario ä¸»é¡Œå››å­æ£‹ï¼Œç­–ç•¥å°æ±ºï¼</p>
      <div id="connect4-board" style="margin:2rem auto;text-align:center;"></div>
      <div id="connect4-result" style="display:none;text-align:center;"></div>
    </section>
    <section class="mario-leaderboard">
      <h2 class="mario-subtitle">æ’è¡Œæ¦œ</h2>
      <ul id="leaderboard-list"></ul>
    </section>
    <div id="save-score-area" style="margin:1.5rem 0;text-align:center;"></div>
  </main>
  <script src="mario-common.js"></script>
  <script>
  // å››å­æ£‹ä¸»ç¨‹å¼
  const ROWS = 6, COLS = 7;
  const board = Array.from({length: ROWS}, () => Array(COLS).fill(0));
  let currentPlayer = 1; // 1=ç´…, 2=é»ƒ
  let gameActive = true;
  
  function renderConnect4() {
    let html = '<div style="display:inline-block;background:#457b9d;padding:10px;border-radius:10px;">';
    
    // æŠ•å¹£æŒ‰éˆ•
    html += '<div style="display:flex;margin-bottom:5px;">';
    for(let x=0;x<COLS;x++){
      html += `<button class="mario-btn" style="width:50px;height:30px;margin:2px;" onclick="dropPiece(${x})" ${!gameActive?'disabled':''}>â†“</button>`;
    }
    html += '</div>';
    
    // æ£‹ç›¤
    for(let y=0;y<ROWS;y++){
      html += '<div style="display:flex;">';
      for(let x=0;x<COLS;x++){
        let color = '#fff';
        if(board[y][x] === 1) color = '#e63946';
        if(board[y][x] === 2) color = '#f7b731';
        html += `<div style="width:50px;height:50px;background:${color};border:3px solid #222;border-radius:50%;margin:2px;"></div>`;
      }
      html += '</div>';
    }
    html += '</div>';
    
    html += `<div style="margin:1em 0;font-size:1.2em;color:#e63946;">ç›®å‰ç©å®¶ï¼š${currentPlayer===1?'ç´…è‰²':'é»ƒè‰²'}</div>`;
    
    document.getElementById('connect4-board').innerHTML = html;
  }
  
  function dropPiece(col) {
    if(!gameActive) return;
    if(startTime === null) startTime = Date.now();
    
    // æ‰¾åˆ°è©²åˆ—æœ€ä¸‹æ–¹çš„ç©ºä½
    for(let row = ROWS-1; row >= 0; row--) {
      if(board[row][col] === 0) {
        board[row][col] = currentPlayer;
        
        if(checkWin(row, col)) {
          gameActive = false;
          endTime = Date.now();
          showResult(`ç©å®¶${currentPlayer===1?'1(ç´…)':'2(é»ƒ)'}å‹åˆ©ï¼`);
        } else if(checkDraw()) {
          gameActive = false;
          endTime = Date.now();
          showResult('å¹³æ‰‹ï¼');
        } else {
          currentPlayer = currentPlayer === 1 ? 2 : 1;
        }
        
        renderConnect4();
        return;
      }
    }
  }
  
  function checkWin(row, col) {
    const player = board[row][col];
    
    // æª¢æŸ¥å››å€‹æ–¹å‘
    const directions = [
      [0,1], [1,0], [1,1], [1,-1] // æ°´å¹³ã€å‚ç›´ã€å°è§’ç·š
    ];
    
    for(let [dx, dy] of directions) {
      let count = 1;
      
      // æ­£æ–¹å‘
      for(let i=1; i<4; i++) {
        const newRow = row + dy*i;
        const newCol = col + dx*i;
        if(newRow >= 0 && newRow < ROWS && newCol >= 0 && newCol < COLS && board[newRow][newCol] === player) {
          count++;
        } else break;
      }
      
      // åæ–¹å‘
      for(let i=1; i<4; i++) {
        const newRow = row - dy*i;
        const newCol = col - dx*i;
        if(newRow >= 0 && newRow < ROWS && newCol >= 0 && newCol < COLS && board[newRow][newCol] === player) {
          count++;
        } else break;
      }
      
      if(count >= 4) return true;
    }
    
    return false;
  }
  
  function checkDraw() {
    return board[0].every(cell => cell !== 0);
  }
  
  renderConnect4();
  let startTime = null;
  let endTime = null;
  function showResult(msg) {
    let timeSec = Math.round((endTime-startTime)/1000);
    let timeStr = timeSec<60?`${timeSec}ç§’`:`${Math.floor(timeSec/60)}åˆ†${timeSec%60}ç§’`;
    document.getElementById('connect4-result').style.display='block';
    document.getElementById('connect4-result').innerHTML = `<h2 class='mario-title'>${msg}</h2><div class='mario-quiz-status'>é€šé—œæ™‚é–“ï¼š<span>${timeStr}</span> <span class='mario-coin'>â±ï¸</span></div><button class='mario-btn' onclick='location.reload()'>å†ç©ä¸€æ¬¡</button>`;
    renderPlayerSelect('save-score-area', function(player) {
      let list = getLeaderboard();
      list.push({ player, score: msg.includes('å‹åˆ©')?1:0, time: Date.now(), clearTime: timeStr });
      saveLeaderboard(list);
      renderLeaderboard();
    });
  }
  const leaderboardKey = 'connect4_leaderboard';
  function getLeaderboard() {
    let data = localStorage.getItem(leaderboardKey);
    if (!data) return [];
    try { return JSON.parse(data); } catch { return []; }
  }
  function saveLeaderboard(list) {
    localStorage.setItem(leaderboardKey, JSON.stringify(list));
  }
  function renderLeaderboard() {
    const list = getLeaderboard();
    const ul = document.getElementById('leaderboard-list');
    if (!ul) return;
    const rankIcons = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    ul.innerHTML = list
      .sort((a, b) => b.score - a.score)
      .map((item, idx) => {
        const icon = rankIcons[idx] || `<span style='font-weight:bold;'>${idx+1}</span>`;
        return `<li>${icon} ${item.player} ${item.score?'å‹åˆ©':'å¹³æ‰‹'} <span style='color:#888;font-size:0.9em;'>${item.clearTime?`ï½œ${item.clearTime}`:''}</span></li>`;
      })
      .join('');
  }
  renderLeaderboard();
  </script>
</body>
</html>
